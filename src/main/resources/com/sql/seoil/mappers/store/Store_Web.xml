<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.seoil.campustown.store.service.impl.StoreMapper">
	
    <sql id="search">
        <if test="searchType != null">
            <if test="searchType == 't'.toString()">
                AND s_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'c'.toString()">
                AND s_content LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'w'.toString()">
            </if>
            <if test="searchType == 'tc'.toString()">
                AND (
                s_name LIKE CONCAT('%', #{keyword}, '%')
                OR s_content LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="searchType == 'cw'.toString()">
            </if>
            <if test="searchType == 'tcw'.toString()">
            </if>
        </if>
    </sql>


	<select id="selectStoreServiceInfo" parameterType="int" resultType="storeVO">
		select s_num
		      ,s_name
		      ,s.c_num
		      ,s_tel
		      ,s_address
		      ,s_content
		      ,s_snsurl
		      ,s_hashtag
		      ,s_hours
		      ,c_category
	      from store s
	      join category c
	        on s.c_num = c.c_num
		 where s_num = #{_parameter}
	</select>
	
	<insert id="insertStoreServiceInfo" parameterType="storeVO" 
			keyProperty="s_num" useGeneratedKeys="true">
		insert into store(
			s_name  , c_num    , s_tel   , s_address, s_content,
			s_snsurl, s_hashtag, s_hours
		) values (
			#{s_name}  , #{c_num}    , #{s_tel}   , #{s_address}, #{s_content},
			#{s_snsurl}, #{s_hashtag}, #{s_hours}
		)
	</insert>
	
	<select id="selectStoreServiceAllList" resultType="storeVO">
		select s_num
		      ,s_name
		      ,c_category
		      ,s_tel
		      ,s_address
		      ,s_content
		      ,s_snsurl
		      ,s_hashtag
		      ,s_hours
	      from store s 
	      join category c 
	        on s.c_num = c.c_num
         order by s_num
	</select>
	
	<select id="selectStoreServiceList" parameterType="criteria" resultType="storeVO">
		<![CDATA[
			select s.s_num
			      ,s_name
			      ,c_category
			      ,s_tel
			      ,s_address
			      ,s_content
			      ,s_snsurl
			      ,s_hashtag
			      ,s_hours
			      ,si_rename
		      from store s
		      join category c 
		        on s.c_num = c.c_num
		      left join store_img si on s.s_num = si.s_num
		     where s.s_num > 0 and (si_num in (select max(si_num)
		     								  from store_img
		     							     group by s_num) or si_num is null)
		]]>
		<if test="category != null and category != 0">
    		and c.c_num = #{category}
    	</if>
       		<include refid="search"/>
        <![CDATA[
       		 order by s_num desc
        	 limit #{pageStart}, #{perPageNum}
        ]]>
	</select>
	
	<select id="selectStoreServiceListCount" parameterType="criteria" resultType="int">
		<![CDATA[
			select count(s_num)
		      from store
		     where s_num > 0
		 ]]>
		 <if test="category != null and category != 0">
    		and c_num = #{category}
    	</if>
		 <include refid="search"/>
	</select>
	
	<select id="selectStoreServiceCategoryList" resultType="map">
		select c_num
		      ,c_category
		      ,c_img
	      from category
		 order by c_num
	</select>
	
	<update id="updateStoreServiceInfo" parameterType="storeVO">
		update store
		   set s_name=#{s_name},
			   c_num=#{c_num},
			   s_tel=#{s_tel},
			   s_address=#{s_address},
			   s_content=#{s_content},
			   s_snsurl=#{s_snsurl},
			   s_hashtag=#{s_hashtag},
			   s_hours=#{s_hours}
		 where s_num = #{s_num}
	</update>
	
	<delete id="deleteStoreServiceInfo">
		delete from store
		 where s_num = #{_parameter}  
	</delete>
	
	<insert id="insertStoreServiceFiles" parameterType="list">
		insert into store_img(
			s_num, si_name, si_rename
		) values 
		<foreach item="item" separator="," collection="list">
			(
				#{item.s_num}, #{item.si_name}, #{item.si_rename}
			)
		</foreach>
	</insert>
	
	<select id="selectStoreServiceFileList" parameterType="int" resultType="map">
		select si_num
		      ,si_name
		      ,si_rename
	      from store_img
		 where s_num = #{_parameter}
		 order by si_num;
	</select>
	
	<delete id="deleteStoreServiceFileInfo">
		delete from store_img
		 where si_num = #{_parameter}  
	</delete>
	
	<delete id="deleteStoreServiceFileList">
		delete from store_img
		 where s_num = #{_parameter}  
	</delete>
	
</mapper>